<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Dodge the Blocks — v10 (Buttons Fixed, All Browsers)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <style>
    :root { --green:#33ff66; --accent:#ff3dac; --scanline:rgba(255,255,255,0.06); }
    html, body { height: 100%; }
    body { margin: 0; background:#1a1a1a; display:flex; justify-content:center; align-items:center; color:#eee; font-family:"Courier New", monospace; }
    canvas { background:#0b0b0b; display:block; border:2px solid #2a2a2a; box-shadow:0 0 24px rgba(0,0,0,.6) inset; z-index:1; pointer-events:auto; touch-action:none; }
    .btn { font-family:inherit; font-weight:bold; padding:12px 22px; font-size:18px; cursor:pointer; margin:6px; border:2px solid var(--green); background:transparent; color:var(--green); text-shadow:0 0 6px rgba(51,255,102,.5); pointer-events:auto; }
    .btn:hover { background: rgba(51,255,102,.1); }
    .btn-accent { border-color: var(--accent); color: var(--accent); text-shadow: 0 0 6px rgba(255,61,172,.6); }
    #topBar { position:fixed; top:8px; left:8px; right:8px; display:flex; gap:8px; align-items:center; justify-content:space-between; z-index:40; font-size:14px; pointer-events:auto; }
    #userInfo { cursor:pointer; pointer-events:auto; }
    #homeOverlay { position:fixed; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center;
      background: repeating-linear-gradient(0deg,transparent 0px, transparent 2px, var(--scanline) 3px, transparent 4px), radial-gradient(circle at 50% 20%, rgba(255,61,172,.12), transparent 40%), #050505;
      text-align:center; overflow:hidden; z-index:30; pointer-events:auto; }
    .retro-box { border:3px solid var(--green); box-shadow:0 0 24px rgba(51,255,102,.25), inset 0 0 12px rgba(51,255,102,.1); padding:22px 28px; background:#0c0c0c; }
    .corner { position:absolute; top:16px; right:16px; display:flex; gap:8px; pointer-events:auto; }
    .overlay { position:fixed; inset:0; background:rgba(0,0,0,.8); display:none; align-items:center; justify-content:center; z-index:70; pointer-events:auto; }
    .modal { width:560px; max-width:92vw; max-height:75vh; overflow:auto; background:#121212; border:2px solid var(--green); box-shadow:0 0 20px rgba(51,255,102,.3); border-radius:8px; padding:16px; }
    #errBanner { position:fixed; bottom:8px; left:8px; right:8px; background:#0e0e0e; color:#e3ffee; padding:8px 10px; border:1px solid #2dd562; border-radius:6px; font-size:12px; z-index:100; display:none; white-space:pre-wrap; }
    #restartBtn { display:none; position:fixed; top:8px; left:50%; transform:translateX(-50%); z-index:50; pointer-events:auto; }
    #cheatBar { position:fixed; bottom:60px; left:50%; transform:translateX(-50%); display:none; gap:8px; z-index:90; background:#0e0e0e; padding:8px 10px; border:1px solid #2a2a2a; border-radius:6px; }
    #cheatInput { padding:8px; font-size:14px; border:1px solid #3a3a3a; background:#0b0b0b; color:#fff; }
    #cheatTableBubble { position:fixed; bottom:120px; left:50%; transform:translateX(-50%); z-index:95; display:none;
      max-width:90vw; background:#0b0b0b; border:1px solid #2a2a2a; border-radius:8px; padding:8px 10px; font-size:12px; color:#cfe; }
    #cheatTableBubble th, #cheatTableBubble td { border:1px solid #333; padding:4px 6px; text-align:left; }
    #cheatTableBubble .close { float:right; cursor:pointer; opacity:.8; }
    #backHomeBtn { display:none; }
  </style>
</head>
<body>
  <div id="topBar">
    <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
      <div id="userInfo" title="Tap while playing to open cheat bar">User: (not set)</div>
      <div id="highInfo">High: 0</div>
      <div id="netInfo"></div>
    </div>
    <div>
      <button id="backHomeBtn" class="btn" type="button">⮐ Back to Home</button>
      <span id="verBadge" style="font-size:11px;opacity:.7;">build: v10</span>
    </div>
  </div>

  <canvas id="gameCanvas" width="400" height="600" tabindex="0" aria-label="Game canvas"></canvas>

  <div id="homeOverlay">
    <div class="retro-box">
      <div id="title" style="font-size:48px;color:#33ff66;text-shadow:0 0 8px rgba(51,255,102,.7);">DODGE THE BLOCKS</div>
      <div id="subtitle" style="margin-bottom:18px;color:#9ad6ad;">made by Ethan Fehler</div>
      <button id="playBtn" class="btn btn-accent" type="button">▶ PLAY</button>
      <div class="pressStart" style="color:#ff3dac;">PRESS PLAY TO START</div>
    </div>
    <div class="corner">
      <button id="lbBtn" class="btn" type="button">LEADERBOARD</button>
      <button id="controlsBtn" class="btn" type="button">CONTROLS</button>
      <button id="setNameBtn" class="btn" type="button">SET USERNAME</button>
    </div>
  </div>

  <div id="lbOverlay" class="overlay">
    <div class="modal">
      <button id="lbClose" class="btn" type="button" style="float:right;">Close</button>
      <h3>Global Leaderboard</h3>
      <table id="lbTable" style="width:100%;border-collapse:collapse;">
        <thead><tr><th>#</th><th>User</th><th>Best Score</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="nameOverlay" class="overlay">
    <div class="modal">
      <button id="nameCancel" class="btn" type="button" style="float:right;">Close</button>
      <h3>Set your username</h3>
      <input id="nameInput" placeholder="e.g., PlayerOne" maxlength="20" autocomplete="off">
      <div id="nameErr" style="color:#ff6b6b;min-height:1.2em;font-size:12px;"></div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px;">
        <button id="nameSave" class="btn btn-accent" type="button">Save</button>
      </div>
    </div>
  </div>

  <div id="controlsOverlay" class="overlay">
    <div class="modal">
      <button id="controlsClose" class="btn" type="button" style="float:right;">Close</button>
      <h3>Keyboard & Touch Controls</h3>
      <ul style="line-height:1.6; margin:0 0 8px 16px;">
        <li>← / → — Move left / right (desktop)</li>
        <li>Drag finger on the canvas — Move the square (mobile)</li>
        <li>P — Pause / resume (gameplay only)</li>
        <li>Enter — Confirm username</li>
        <li>Esc — Close the current dialog</li>
        <li>E — Toggle error banner</li>
        <li>Space — Toggle diagnostics HUD (unless typing)</li>
      </ul>
    </div>
  </div>

  <div id="cheatBar"><input type="password" id="cheatInput" placeholder="Enter cheat code"><button id="applyCheat" class="btn" type="button">Apply</button></div>
  <div id="cheatTableBubble"></div>
  <button id="restartBtn" class="btn" type="button">Restart</button>

  <div id="errBanner"></div>

  <script>
  (function(){
    const errEl = document.getElementById('errBanner');
    function showErr(msg){ errEl.textContent = '⚠ ' + msg; errEl.style.display = 'block'; console.warn(msg); }
    function hideErr(){ errEl.style.display='none'; }

    const $ = (id)=>document.getElementById(id);
    const userInfo=$('userInfo'), highInfo=$('highInfo'), netInfo=$('netInfo');
    const homeOverlay=$('homeOverlay'), controlsOverlay=$('controlsOverlay');
    const lbOverlay=$('lbOverlay'), nameOverlay=$('nameOverlay');
    const nameInput=$('nameInput'), nameErr=$('nameErr');
    const canvas=$('gameCanvas'), ctx=canvas.getContext('2d');
    const restartBtn=$('restartBtn'), backHomeBtn=$('backHomeBtn');
    const cheatBar=$('cheatBar'), cheatInput=$('cheatInput');

    // Local storage helpers
    const loadScoresLocal=()=>{ try{return JSON.parse(localStorage.getItem('dodge_scores')||'{}');}catch{return{};} };
    const saveScoresLocal=o=> localStorage.setItem('dodge_scores', JSON.stringify(o));
    const getUser=()=> (localStorage.getItem('dodge_user')||'').trim();
    const setUser=u=> localStorage.setItem('dodge_user', u);
    const updateSetNameButton=()=>{ const b=$('setNameBtn'); if(b) b.textContent=getUser()?'EDIT USERNAME':'SET USERNAME'; };

    // Game state
    const player={x:180,y:550,width:40,height:40,speed:24,color:'lime'};
    let obstacles=[], baseObstacleSpeed=4, obstacleSpeed=baseObstacleSpeed;
    let score=0, gameOver=false, baseSpawnInterval=500, spawnInterval=baseSpawnInterval;
    let spawnTimer=null, paused=true, speedIncreaseTimer=null, maxObstacleSpeed=12;
    let keys={left:false,right:false}; let screen='home', lbOpen=false;

    const cheats={ godmode:false, reverse:false, rainbow:false, ghost:false, speedy:false, bigplayer:false, tinyplayer:false, slowmo:null, slowtime:null, fastspawn:null, table:false };
    let cheatedThisRun=false;

    function updateUserUI(){
      const u=getUser();
      userInfo.textContent='User: '+(u||'(not set)');
      const localScores=loadScoresLocal();
      const localBest=u && localScores[u] ? localScores[u] : 0;
      highInfo.textContent='High: '+localBest;
      netInfo.textContent='Offline leaderboard';
    }

    function openNameModal(prefill=''){ nameOverlay.style.display='flex'; nameInput.value=prefill; nameErr.textContent=''; setTimeout(()=>{ try{nameInput.focus();}catch{} },0); }
    function closeNameModal(){ nameOverlay.style.display='none'; }

    function saveBestLocal(u,s){ const scores=loadScoresLocal(); const prev=scores[u]||0; if(s>prev){ scores[u]=s; saveScoresLocal(scores);} }

    function onDeath(){
      if(gameOver) return;
      gameOver=true; clearInterval(spawnTimer); clearInterval(speedIncreaseTimer);
      const u=getUser(); if(u) saveBestLocal(u,score);
      restartBtn.style.display='inline-block';
      showErr('E_DEAD: Hit a block — press Restart');
    }

    function spawnObstacle(){ if(!paused && !gameOver){ const w=Math.random()*60+20, x=Math.random()*(canvas.width-w); obstacles.push({x, y: cheats.reverse? canvas.height+20 : -20, width:w, height:20, color:'red'});} }
    function startSpawning(){ clearInterval(spawnTimer); spawnTimer=setInterval(spawnObstacle, spawnInterval); }
    function startSpeedIncrease(){ clearInterval(speedIncreaseTimer); speedIncreaseTimer=setInterval(()=>{ if(!paused && !gameOver && baseObstacleSpeed<maxObstacleSpeed){ baseObstacleSpeed+=0.5; refreshEffectiveSpeeds(); } },10000); }
    function refreshEffectiveSpeeds(){
      if (cheats.slowmo != null) obstacleSpeed = Number(cheats.slowmo);
      else if (cheats.slowtime != null) obstacleSpeed = Number(cheats.slowtime);
      else obstacleSpeed = baseObstacleSpeed;
      let newSpawn = baseSpawnInterval;
      if (cheats.fastspawn != null) newSpawn = Number(cheats.fastspawn);
      else if (cheats.slowtime != null) newSpawn = 1500;
      if (newSpawn !== spawnInterval){ spawnInterval = newSpawn; startSpawning(); }
    }
    function update(){
      if(gameOver||paused||screen!=='playing') return;
      if(keys.left) player.x-=player.speed;
      if(keys.right) player.x+=player.speed;
      if(player.x<0) player.x=0;
      if(player.x+player.width>canvas.width) player.x=canvas.width-player.width;
      obstacles.forEach(o=> o.y += (cheats.reverse? -obstacleSpeed : obstacleSpeed));
      obstacles = obstacles.filter(o=> o.y<canvas.height+40 && o.y>-40);
      if(!cheats.godmode){
        for(const o of obstacles){
          if(player.x < o.x + o.width && player.x + player.width > o.x && player.y < o.y + o.height && player.y + player.height > o.y){
            onDeath(); break;
          }
        }
      }
      score += (cheats.reverse ? -1 : 1);
      if(cheats.rainbow){
        player.color = `hsl(${(Date.now()/10)%360},100%,50%)`;
        obstacles.forEach((o,i)=> o.color = `hsl(${(Date.now()/10 + i*20)%360},100%,50%)`);
      } else {
        player.color = cheats.ghost ? 'rgba(0,0,0,0)' : 'lime';
      }
    }
    function draw(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle=player.color; ctx.fillRect(player.x,player.y,player.width,player.height);
      obstacles.forEach(o=>{ ctx.fillStyle=o.color; ctx.fillRect(o.x,o.y,o.width,o.height); });
      ctx.fillStyle='white'; ctx.font='20px Arial'; ctx.fillText('Score: '+score,10,30);
      if(gameOver){ ctx.fillStyle='yellow'; ctx.font='40px Arial'; ctx.fillText('GAME OVER',80,canvas.height/2); }
      if(paused || screen!=='playing'){ ctx.fillStyle='orange'; ctx.font='30px Arial'; ctx.fillText('PAUSED',150,canvas.height/2); }
    }
    (function loop(){ update(); draw(); requestAnimationFrame(loop); })();

    function goHome(){ screen='home'; paused=true; gameOver=false; homeOverlay.style.display='flex'; backHomeBtn.style.display='none'; restartBtn.style.display='none'; clearInterval(spawnTimer); clearInterval(speedIncreaseTimer); document.body.style.overflow='auto'; }
    function startPlaying(){
      if(!getUser()){ openNameModal(''); return; }
      screen='playing'; paused=false; gameOver=false; score=0; obstacles=[]; cheatedThisRun=false;
      player.x=180; player.width=40; player.height=40; player.speed=24;
      baseObstacleSpeed=4; obstacleSpeed=baseObstacleSpeed; baseSpawnInterval=500; spawnInterval=baseSpawnInterval;
      Object.keys(cheats).forEach(c=>cheats[c]=(typeof cheats[c]==='boolean'?false:null));
      homeOverlay.style.display='none'; backHomeBtn.style.display='inline-block'; restartBtn.style.display='none';
      startSpawning(); startSpeedIncrease(); refreshEffectiveSpeeds();
      document.body.style.overflow='hidden'; canvas.focus();
      hideErr();
    }

    async function openLeaderboard(){
      const tbody = document.querySelector('#lbTable tbody');
      tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;opacity:.8;">Local scores (offline)</td></tr>';
      const scores=loadScoresLocal();
      const rows=Object.keys(scores).map(u=>({username:u,best:scores[u]})).sort((a,b)=>b.best-a.best).slice(0,50);
      if(rows.length) tbody.innerHTML = rows.map((r,i)=>`<tr><td>${i+1}</td><td>${r.username}</td><td>${r.best}</td></tr>`).join('');
      lbOverlay.style.display='flex'; lbOpen=true;
    }
    function closeLeaderboard(){ lbOverlay.style.display='none'; lbOpen=false; }

    function showCheatBar(){ if(screen!=='playing') return; paused=true; cheatBar.style.display='flex'; setTimeout(()=>{ try{cheatInput.focus();}catch{} },0); }
    function closeCheatBar(){ cheatBar.style.display='none'; cheatInput.value=''; if(screen==='playing'&&!gameOver) paused=false; }
    function applyCheatCode(){
      const raw=(cheatInput.value||'').trim().toLowerCase(); if(!raw){ closeCheatBar(); return; }
      if(raw.startsWith('disable ')){
        const d=raw.slice(8).trim();
        if(d==='godmode') cheats.godmode=false;
        if(d==='reverse') cheats.reverse=false;
        if(d==='rainbow') cheats.rainbow=false;
        if(d==='ghost') cheats.ghost=false;
        if(d==='speedy') { cheats.speedy=false; player.speed=24; }
        if(d==='bigplayer' || d==='tinyplayer'){ cheats.bigplayer=false; cheats.tinyplayer=false; player.width=40; player.height=40; }
        if(d==='slowmo') cheats.slowmo=null;
        if(d==='slowtime') cheats.slowtime=null;
        if(d==='fastspawn') cheats.fastspawn=null;
        refreshEffectiveSpeeds(); closeCheatBar(); return;
      }
      const m=raw.match(/^([a-z]+)(\d+)?$/); if(!m){ closeCheatBar(); return; }
      const base=m[1], num=m[2]?parseInt(m[2],10):null;
      if(base in cheats && typeof cheats[base]==='boolean'){
        cheats[base]=true;
        if(base==='speedy') player.speed=35;
        if(base==='bigplayer'){ player.width=80; player.height=80; }
        if(base==='tinyplayer'){ player.width=20; player.height=20; }
      } else if(base==='points'){
        score += (num!=null?num:1000);
      } else if(base==='slowmo'){
        cheats.slowmo = (num!=null?num:1);
      } else if(base==='slowtime'){
        cheats.slowtime = (num!=null?num:1);
      } else if(base==='fastspawn'){
        cheats.fastspawn = (num!=null?num:200);
      } else if(base==='clear'){
        obstacles = [];
      }
      refreshEffectiveSpeeds();
      closeCheatBar();
    }

    // Global delegated clicks (works across Safari/overlays)
    document.addEventListener('click', function(e){
      const btn = e.target.closest('button');
      if(!btn) return;
      const id = btn.id;
      if(id === 'playBtn'){ e.preventDefault(); startPlaying(); }
      else if(id === 'lbBtn'){ e.preventDefault(); openLeaderboard(); }
      else if(id === 'lbClose'){ e.preventDefault(); closeLeaderboard(); }
      else if(id === 'setNameBtn'){ e.preventDefault(); openNameModal(getUser()); }
      else if(id === 'nameSave'){ e.preventDefault();
        const u=(nameInput.value||'').trim(); if(!u){ nameErr.textContent='Please enter a username.'; return; }
        setUser(u); updateSetNameButton(); userInfo.textContent='User: '+u; closeNameModal(); updateUserUI();
      }
      else if(id === 'nameCancel'){ e.preventDefault(); closeNameModal(); }
      else if(id === 'controlsBtn'){ e.preventDefault(); controlsOverlay.style.display='flex'; }
      else if(id === 'controlsClose'){ e.preventDefault(); controlsOverlay.style.display='none'; }
      else if(id === 'restartBtn'){ e.preventDefault(); if(screen==='playing'){ startPlaying(); } }
      else if(id === 'backHomeBtn'){ e.preventDefault(); goHome(); }
      else if(id === 'applyCheat'){ e.preventDefault(); applyCheatCode(); }
    }, {capture:true});

    // Username area click: in play opens cheat bar; otherwise open name modal
    userInfo.addEventListener('click', function(){ if(screen==='playing'){ showCheatBar(); } else { openNameModal(getUser()); } });

    // Touch/drag move
    let dragging=false;
    const canvasX = (clientX)=>{ const r=canvas.getBoundingClientRect(); const x=(clientX-r.left)*(canvas.width/r.width); return Math.max(0, Math.min(canvas.width-player.width, x-player.width/2)); };
    canvas.addEventListener('mousedown', e=>{ if(screen!=='playing') return; e.preventDefault(); dragging=true; player.x=canvasX(e.clientX); });
    window.addEventListener('mousemove', e=>{ if(dragging && screen==='playing'){ e.preventDefault(); player.x=canvasX(e.clientX); } });
    window.addEventListener('mouseup', ()=>{ dragging=false; });
    canvas.addEventListener('touchstart', e=>{ if(screen!=='playing') return; if(e.touches[0]){ e.preventDefault(); dragging=true; player.x=canvasX(e.touches[0].clientX);} }, {passive:false});
    canvas.addEventListener('touchmove', e=>{ if(dragging && e.touches[0]){ e.preventDefault(); player.x=canvasX(e.touches[0].clientX);} }, {passive:false});
    canvas.addEventListener('touchend', e=>{ e.preventDefault(); dragging=false; }, {passive:false});
    canvas.addEventListener('touchcancel', e=>{ e.preventDefault(); dragging=false; }, {passive:false});

    // Keyboard
    function isTypingTarget(t){ return t && (t.tagName==='INPUT' || t.tagName==='TEXTAREA' || t.isContentEditable); }
    window.addEventListener('keydown', (e)=>{
      if((e.key==='e'||e.key==='E') && !isTypingTarget(e.target)){ e.preventDefault(); errEl.style.display = (errEl.style.display==='block' ? 'none' : 'block'); return; }
      const typing = isTypingTarget(e.target) || (cheatBar.style.display==='flex');
      if(screen==='playing' && !lbOpen && !typing){
        if(e.key==='ArrowLeft' || e.key==='Left' || e.keyCode===37){ e.preventDefault(); keys.left=true; }
        if(e.key==='ArrowRight' || e.key==='Right' || e.keyCode===39){ e.preventDefault(); keys.right=true; }
        if(e.key==='p' || e.key==='P' || e.keyCode===80){ e.preventDefault(); paused=!paused; }
        if(e.key==='Shift'){ e.preventDefault(); showCheatBar(); }
      }
      if(cheatBar.style.display==='flex'){
        if(e.key==='Enter'){ e.preventDefault(); applyCheatCode(); }
        if(e.key==='Escape'){ e.preventDefault(); closeCheatBar(); }
      }
      if(nameOverlay.style.display==='flex'){
        if(e.key==='Enter'){ e.preventDefault();
          const u=(nameInput.value||'').trim(); if(!u){ nameErr.textContent='Please enter a username.'; return; }
          setUser(u); updateSetNameButton(); userInfo.textContent='User: '+u; closeNameModal(); updateUserUI();
        }
        if(e.key==='Escape'){ e.preventDefault(); closeNameModal(); }
      }
    });
    window.addEventListener('keyup', (e)=>{
      if(screen==='playing' && !lbOpen && !(isTypingTarget(e.target))){
        if(e.key==='ArrowLeft' || e.key==='Left' || e.keyCode===37){ e.preventDefault(); keys.left=false; }
        if(e.key==='ArrowRight' || e.key==='Right' || e.keyCode===39){ e.preventDefault(); keys.right=false; }
      }
    });

    // Init
    updateSetNameButton();
    updateUserUI();
  })();
  </script>
</body>
</html>
